"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[8196],{3637:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>r,contentTitle:()=>l,default:()=>h,frontMatter:()=>i,metadata:()=>a,toc:()=>d});var o=n(5893),s=n(1151);const i={id:"context",title:"Context"},l=void 0,a={id:"podlet/context",title:"Context",description:"A podlet is intended to be used within multiple layouts but for this to be possible a podlet",source:"@site/docs/podlet/context.md",sourceDirName:"podlet",slug:"/podlet/context",permalink:"/docs/podlet/context",draft:!1,unlisted:!1,editUrl:"https://github.com/podium-lib/podium-lib.github.io/tree/main/website/docs/docs/podlet/context.md",tags:[],version:"current",frontMatter:{id:"context",title:"Context"},sidebar:"sidebar",previous:{title:"Fallbacks",permalink:"/docs/podlet/fallbacks"},next:{title:"Proxying",permalink:"/docs/podlet/proxying"}},r={},d=[{value:"Default Context Variables",id:"default-context-variables",level:2},{value:"Consuming Context Values In A Podlet",id:"consuming-context-values-in-a-podlet",level:2},{value:"URL construction",id:"url-construction",level:3},{value:"Requests from non layout servers",id:"requests-from-non-layout-servers",level:3},{value:"Client side JavaScript and the context",id:"client-side-javascript-and-the-context",level:3},{value:"Putting it all together",id:"putting-it-all-together",level:2}];function c(e){const t={a:"a",code:"code",em:"em",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.a)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(t.p,{children:"A podlet is intended to be used within multiple layouts but for this to be possible a podlet\nneeds to be able to access certain pieces of data from each layout server so that it can\ndetermine how to respond."}),"\n",(0,o.jsx)(t.p,{children:"The purpose of the Podium context then is to give a podlet access to background contextual information about each incoming HTTP request so that the podlet can taylor its response accordingly."}),"\n",(0,o.jsx)(t.p,{children:"More specifically, a podlet can make use of the context to:"}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsx)(t.li,{children:"construct URLs back to the layout where the request originated"}),"\n",(0,o.jsxs)(t.li,{children:["respond differently depending on locale eg. ",(0,o.jsx)(t.code,{children:"en-US"})," or ",(0,o.jsx)(t.code,{children:"no-NO"})]}),"\n",(0,o.jsxs)(t.li,{children:["respond differently depending on what type of device environment was used to make the request eg. ",(0,o.jsx)(t.code,{children:"mobile"})," or ",(0,o.jsx)(t.code,{children:"desktop"})]}),"\n",(0,o.jsx)(t.li,{children:"respond differently depending on whether the layout is in debug mode or not"}),"\n"]}),"\n",(0,o.jsx)(t.p,{children:"In Podium, this context information is sent as a set of HTTP headers with every request (including proxy requests) from a\nlayout server to a podlet."}),"\n",(0,o.jsx)(t.h2,{id:"default-context-variables",children:"Default Context Variables"}),"\n",(0,o.jsx)(t.p,{children:"Podium has a default set of context variables which are always present. These are:"}),"\n",(0,o.jsxs)(t.table,{children:[(0,o.jsx)(t.thead,{children:(0,o.jsxs)(t.tr,{children:[(0,o.jsx)(t.th,{children:"Name"}),(0,o.jsx)(t.th,{children:"Header Name"}),(0,o.jsx)(t.th,{children:"Context Name"}),(0,o.jsx)(t.th,{children:"Description"})]})}),(0,o.jsxs)(t.tbody,{children:[(0,o.jsxs)(t.tr,{children:[(0,o.jsx)(t.td,{children:"Debug"}),(0,o.jsx)(t.td,{children:(0,o.jsx)(t.code,{children:"podium-debug"})}),(0,o.jsx)(t.td,{children:(0,o.jsx)(t.code,{children:"debug"})}),(0,o.jsxs)(t.td,{children:["A boolean value informing the podlet whether the layout is in debug mode or not. Defaults to ",(0,o.jsx)(t.code,{children:"false"})]})]}),(0,o.jsxs)(t.tr,{children:[(0,o.jsx)(t.td,{children:"Locale"}),(0,o.jsx)(t.td,{children:(0,o.jsx)(t.code,{children:"podium-locale"})}),(0,o.jsx)(t.td,{children:(0,o.jsx)(t.code,{children:"locale"})}),(0,o.jsxs)(t.td,{children:["A ",(0,o.jsx)(t.a,{href:"https://tools.ietf.org/html/bcp47",children:"bcp47"})," compliant locale string with locale information from the layout. Defaults to ",(0,o.jsx)(t.code,{children:"en-US"})]})]}),(0,o.jsxs)(t.tr,{children:[(0,o.jsx)(t.td,{children:"Device Type"}),(0,o.jsx)(t.td,{children:(0,o.jsx)(t.code,{children:"podium-device-type"})}),(0,o.jsx)(t.td,{children:(0,o.jsx)(t.code,{children:"deviceType"})}),(0,o.jsxs)(t.td,{children:["A guess (based on user-agent) as to the device type of the browser requesting the page from a layout server. Possible values are ",(0,o.jsx)(t.code,{children:"desktop"}),", ",(0,o.jsx)(t.code,{children:"tablet"})," and ",(0,o.jsx)(t.code,{children:"mobile"}),". Defaults to ",(0,o.jsx)(t.code,{children:"desktop"})]})]}),(0,o.jsxs)(t.tr,{children:[(0,o.jsx)(t.td,{children:"Mount Origin"}),(0,o.jsx)(t.td,{children:(0,o.jsx)(t.code,{children:"podium-mount-origin"})}),(0,o.jsx)(t.td,{children:(0,o.jsx)(t.code,{children:"mountOrigin"})}),(0,o.jsxs)(t.td,{children:["URL origin of the inbound request to the layout server. For example, if the layout server is serving requests on the domain ",(0,o.jsx)(t.a,{href:"http://www.foo.com",children:"http://www.foo.com"})," this value will be ",(0,o.jsx)(t.code,{children:"http://www.foo.com"})]})]}),(0,o.jsxs)(t.tr,{children:[(0,o.jsx)(t.td,{children:"Mount Pathname"}),(0,o.jsx)(t.td,{children:(0,o.jsx)(t.code,{children:"podium-mount-pathname"})}),(0,o.jsx)(t.td,{children:(0,o.jsx)(t.code,{children:"mountPathname"})}),(0,o.jsxs)(t.td,{children:["URL path to where a layout is mounted in an HTTP server. This value is the same as the layout's ",(0,o.jsx)(t.code,{children:"pathname"})," option. For example, if the layout server has mounted a layout on the pathname ",(0,o.jsx)(t.code,{children:"/bar"})," (",(0,o.jsx)(t.a,{href:"http://www.foo.com/bar",children:"http://www.foo.com/bar"}),") this value will be ",(0,o.jsx)(t.code,{children:"/bar"}),"."]})]}),(0,o.jsxs)(t.tr,{children:[(0,o.jsx)(t.td,{children:"Public Pathname"}),(0,o.jsx)(t.td,{children:(0,o.jsx)(t.code,{children:"podium-public-pathname"})}),(0,o.jsx)(t.td,{children:(0,o.jsx)(t.code,{children:"publicPathname"})}),(0,o.jsxs)(t.td,{children:["URL path to where a layout server has mounted a proxy in order to proxy public traffic to a podlet. The full public pathname is built up by joining together the value of Mount Pathname with a prefix value. The prefix value is there to define a namespace to isolate the proxy from other HTTP routes defined under the same mount pathname. The default prefix value is ",(0,o.jsx)(t.code,{children:"podium-resource"}),". For example, if the layout server has mounted a layout on the pathname ",(0,o.jsx)(t.code,{children:"/bar"})," (",(0,o.jsx)(t.a,{href:"http://www.foo.com/bar",children:"http://www.foo.com/bar"}),") this value will be ",(0,o.jsx)(t.code,{children:"/bar/podium-resource/"}),"."]})]})]})]}),"\n",(0,o.jsx)(t.h2,{id:"consuming-context-values-in-a-podlet",children:"Consuming Context Values In A Podlet"}),"\n",(0,o.jsxs)(t.p,{children:["(For information on working with the Podium Context within layouts including setting defaults and adding values, please see the ",(0,o.jsx)(t.a,{href:"https://github.com/podium-lib/layout",children:"@podium/layout"})," module documentation.)"]}),"\n",(0,o.jsxs)(t.p,{children:["Since Context values are sent to podlets from layouts as headers, to make them easier to work with, the ",(0,o.jsx)(t.a,{href:"https://github.com/podium-lib/podlet",children:"@podium/podlet"})," module contains a ",(0,o.jsx)(t.code,{children:"de-serializer"})," which converts context headers into object keys and values and places them on the HTTP response object at ",(0,o.jsx)(t.code,{children:"res.locals.podium.context"})," for use in later middleware and/or routes."]}),"\n",(0,o.jsx)(t.p,{children:"When you mount the podlet's middleware into an app this de-serialization process will occur automatically on each request."}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.em,{children:"Example: adding podlet middleware"})}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-js",children:"app.use(podlet.middleware());\n"})}),"\n",(0,o.jsxs)(t.p,{children:["Note: As shown in the table above, context names are converted from ",(0,o.jsx)(t.a,{href:"https://en.wikipedia.org/wiki/Kebab_case",children:"kebab case"})," to ",(0,o.jsx)(t.a,{href:"https://en.wikipedia.org/wiki/Camel_case",children:"camel case"})," and the Podium prefix is removed so that the ",(0,o.jsx)(t.code,{children:"podium-mount-origin"})," header will be set as ",(0,o.jsx)(t.code,{children:"mountOrigin"})," on ",(0,o.jsx)(t.code,{children:"res.locals.podium.context"}),"."]}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.em,{children:"Example: accessing de-serialized context values in later middleware"})}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-js",children:"app.use((req, res, next) => {\n    // res.locals.podium.context.locale\n    next();\n});\n"})}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.em,{children:"Example: accessing de-serialized context values in an express route"})}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-js",children:"app.get('/', (req, res, next) => {\n    // res.locals.podium.context.deviceType\n});\n"})}),"\n",(0,o.jsx)(t.h3,{id:"url-construction",children:"URL construction"}),"\n",(0,o.jsx)(t.p,{children:"Perhaps the most important thing the Context is typically used for is to construct URLs linking back to the layout that a podlet is being sent a request from."}),"\n",(0,o.jsxs)(t.p,{children:["In a podlet, the origin of a layout server can be found at ",(0,o.jsx)(t.code,{children:"res.locals.podium.context.mountOrigin"}),"\nand the pathname to the layout server can be found at ",(0,o.jsx)(t.code,{children:"res.locals.podium.context.mountPathname"}),"."]}),"\n",(0,o.jsxs)(t.p,{children:["These adher to the ",(0,o.jsx)(t.a,{href:"https://url.spec.whatwg.org/",children:"WHATWG URL"})," spec so you can easily compose full URLs by using the ",(0,o.jsx)(t.a,{href:"https://nodejs.org/api/url.html#url_class_url",children:"URL"})," module in node.js."]}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.em,{children:"Example: using the URL module to construct urls from context values"})}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-js",children:"const { URL } = require('url');\nconst { mountOrigin, mountPathname } = res.locals.podium.context;\nconst url = new URL(mountPathname, mountOrigin);\n// url.href => <mountOrigin>/<mountPathname>\n// eg. http://localhost:3040/cats\n"})}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.em,{children:"Example: using the URL module to construct proxy urls from context values"})}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-js",children:"const { URL } = require('url');\nconst { mountOrigin, publicPathname } = res.locals.podium.context;\nconst url = new URL(publicPathname, mountOrigin);\n// url.href => <mountOrigin>/<publicPathname>\n// eg. http://localhost:3040/cats/podium-resource\n"})}),"\n",(0,o.jsx)(t.h3,{id:"requests-from-non-layout-servers",children:"Requests from non layout servers"}),"\n",(0,o.jsxs)(t.p,{children:["The context is appended to requests from layout servers to podlet servers, but when testing the podlet in isolation you will want to be able to send requests to podlets directly, bypassing Layouts entirely. Such requests will not\nhave the appropriate context headers set and will therefore not be able to populate the ",(0,o.jsx)(t.code,{children:"res.locals.podium.context"})," object."]}),"\n",(0,o.jsxs)(t.p,{children:["To support this use case, a ",(0,o.jsx)(t.code,{children:".defaults()"})," method is provided on the ",(0,o.jsx)(t.a,{href:"https://github.com/podium-lib/podlet",children:"@podium/podlet"})," instance. In order to use this, you must set the ",(0,o.jsx)(t.a,{href:"https://github.com/podium-lib/podlet",children:"@podium/podlet"})," constructor argument ",(0,o.jsx)(t.code,{children:"development"})," to ",(0,o.jsx)(t.code,{children:"true"}),"."]}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.em,{children:"Example: enabling default context support in a Podlet"})}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-js",children:"// Enable defaults which will set a default Context\nconst podlet = new Podlet({\n    ...\n    development: true,\n});\n"})}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.em,{children:"Example: setting default context values"})}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-js",children:"// Set default locale to Norwegian\npodlet.defaults({\n    locale: 'nb-NO',\n});\n"})}),"\n",(0,o.jsxs)(t.p,{children:["This is very handy during development, but it is advisable that these defaults\nbe turned off when running in production. Consider using ",(0,o.jsx)(t.code,{children:"NODE_ENV"})," to enable/disable defaults based on the environment."]}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.em,{children:"Example: disabling defaults in production"})}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-js",children:"const podlet = new Podlet({\n    ...\n    development: process.env.NODE_ENV !== 'production',\n});\n"})}),"\n",(0,o.jsx)(t.h3,{id:"client-side-javascript-and-the-context",children:"Client side JavaScript and the context"}),"\n",(0,o.jsx)(t.p,{children:"There are many occasions when you will want access to context values client side. Making AJAX requests to proxy endpoints and client side page navigation are two such common cases."}),"\n",(0,o.jsx)(t.p,{children:"We recommend the following 2 step approach to sharing context values between backend Node.js code and client side code."}),"\n",(0,o.jsxs)(t.ol,{children:["\n",(0,o.jsx)(t.li,{children:"write required context values to the dom in your content route"}),"\n",(0,o.jsx)(t.li,{children:"read from the dom in your client side code"}),"\n"]}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.em,{children:"Example: writing context values to the dom in an express route"})}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-js",children:'app.get(\'/\', (req, res) => {\n    const {\n        mountOrigin,\n        mountPathname,\n        publicPathname,\n    } = res.locals.podium.context;\n\n    res.send(`\n        <div\n            id="app"\n            data-mount-origin="${mountOrigin}"\n            data-mount-pathname="${mountPathname}"\n            data-public-pathname="${publicPathname}"\n        ></div>\n    `);\n});\n'})}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.em,{children:"Example: reading context values from the dom in client side JavaScript"})}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-js",children:"const app = document.getElementById('app');\nconst { mountOrigin, mountPathname, publicPathname } = app.dataset;\n"})}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.em,{children:"Example: constructing a URL in client side JavaScript"})}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-js",children:"const url = new URL(mountPathname, mountOrigin).href;\n"})}),"\n",(0,o.jsx)(t.h2,{id:"putting-it-all-together",children:"Putting it all together"}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.em,{children:"Example: building a Podlet with a default context that passes values to the client"})}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-js",children:"const Podlet = require('@podium/podlet');\nconst app = require('express')();\n\n// Enable defaults which will set a default Context\nconst podlet = new Podlet({\n    version: '2.0.0',\n    name: 'demo',\n    pathname: '/',\n\n    // turn on for development only\n    development: process.env.NODE_ENV !== 'production',\n});\n\n// Set default locale to Norwegian\npodlet.defaults({\n    locale: 'nb-NO',\n});\n\n// mount middleware to ensure context headers are parsed\napp.use(podlet.middleware());\n\napp.get('/', (req, res, next) => {\n    const {\n        mountOrigin,\n        mountPathname,\n        publicPathname,\n        locale,\n    } = res.locals.podium.context;\n\n    // offer one response to Norwegian speakers...\n    if (locale === 'en-NO') {\n        res.status(200).podiumSend(`\n        <div\n            id=\"app\"\n            data-mount-origin=\"${mountOrigin}\"\n            data-mount-pathname=\"${mountPathname}\"\n            data-public-pathname=\"${publicPathname}\"\n        >\n        Hei!\n        </div>\n    `);\n    } else {\n        // ...and another to English speakers\n        res.status(200).podiumSend('English is not supported at this time.');\n    }\n});\n"})}),"\n",(0,o.jsxs)(t.p,{children:["Please see the ",(0,o.jsx)(t.a,{href:"https://github.com/podium-lib/podlet",children:"@podium/podlet"})," module for more detailed documentation."]})]})}function h(e={}){const{wrapper:t}={...(0,s.a)(),...e.components};return t?(0,o.jsx)(t,{...e,children:(0,o.jsx)(c,{...e})}):c(e)}},1151:(e,t,n)=>{n.d(t,{Z:()=>a,a:()=>l});var o=n(7294);const s={},i=o.createContext(s);function l(e){const t=o.useContext(i);return o.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:l(e.components),o.createElement(i.Provider,{value:t},e.children)}}}]);