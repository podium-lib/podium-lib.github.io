"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[5034],{4407:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>r,default:()=>p,frontMatter:()=>i,metadata:()=>a,toc:()=>d});var o=n(5893),s=n(1151);const i={id:"proxying",title:"Proxying"},r=void 0,a={id:"podlet/proxying",title:"Proxying",description:"While Podium does not enforce what type of infrastructure is used to run podlet and layout servers, a common decision that will have to be made when using Podium is whether podlet servers should be publicly accessible or whether they should be accessible only through the layout server. This decision can impact how client side code is written due to a common need to communicate back directly from client code to podlet server.",source:"@site/docs/podlet/proxying.md",sourceDirName:"podlet",slug:"/podlet/proxying",permalink:"/docs/podlet/proxying",draft:!1,unlisted:!1,editUrl:"https://github.com/podium-lib/podium-lib.github.io/tree/main/website/docs/docs/podlet/proxying.md",tags:[],version:"current",frontMatter:{id:"proxying",title:"Proxying"},sidebar:"sidebar",previous:{title:"Context",permalink:"/docs/podlet/context"},next:{title:"Local Development",permalink:"/docs/podlet/local_development"}},l={},d=[{value:"Podium Proxy",id:"podium-proxy",level:2},{value:"How it works",id:"how-it-works",level:3},{value:"Programmatically defining proxy routes",id:"programmatically-defining-proxy-routes",level:3},{value:"Constructing Proxy URLs",id:"constructing-proxy-urls",level:3},{value:"Example: client side JavaScript fetching data from a /content route",id:"example-client-side-javascript-fetching-data-from-a-content-route",level:3}];function c(e){const t={a:"a",code:"code",em:"em",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,s.a)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(t.p,{children:"While Podium does not enforce what type of infrastructure is used to run podlet and layout servers, a common decision that will have to be made when using Podium is whether podlet servers should be publicly accessible or whether they should be accessible only through the layout server. This decision can impact how client side code is written due to a common need to communicate back directly from client code to podlet server."}),"\n",(0,o.jsx)(t.p,{children:"In some cases, you may not wish to expose your podlets to the outside world, instead prefering to expose only layouts and let the layouts do the work of fetching content from internally placed podlets."}),"\n",(0,o.jsx)(t.p,{children:"A podlet server that is not exposed to the outside world except via a layout server that consumes its content will likely still need a way to define additional routes and make them publicly available."}),"\n",(0,o.jsxs)(t.p,{children:["Two very common use cases for this are when performing form submissions against a podlet and when making AJAX requests from client side code to a podlet. For example, a podlet might define an additional route at ",(0,o.jsx)(t.code,{children:"/api"})," which is provided so that the client side JavaScript served by this podlet can fetch additional data asynchonously after page load."]}),"\n",(0,o.jsxs)(t.p,{children:["By default, a podlet serves up its content at ",(0,o.jsx)(t.code,{children:"/"}),". While you can change this to a different route, ",(0,o.jsx)(t.code,{children:"/content"})," for example, out of the box, no other routes will be accessible. In our example above, it will not be possible for the client side JavaScript code to make a request to ",(0,o.jsx)(t.code,{children:"/api"})," as this code is now running in the layout and the layout does not provide an ",(0,o.jsx)(t.code,{children:"/api"})," route. And since the podlet itself has no public address, there's no way to send a request directly to the podlet's ",(0,o.jsx)(t.code,{children:"/api"})," route using an absolute URL either."]}),"\n",(0,o.jsx)(t.p,{children:"To cater for this need to communicate directly with podlet servers, Podium provides a proxy feature. A Podium proxy is a transparent proxy that is mounted in the layout server making it possible to send any HTTP request through it back to the podlet server."}),"\n",(0,o.jsx)(t.p,{children:"If your infrastructure is setup such that podlet servers are only available through layout servers then using the Podium Proxy is the prefered way to make parts of a podlet server publically available."}),"\n",(0,o.jsxs)(t.p,{children:["If, on the other hand, your infrastructure is setup such that podlet servers are fully publically available then the approach taken can simply be for client side code to communicate with the podlet server directly by enabling ",(0,o.jsx)(t.a,{href:"https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS",children:"CORS"}),"."]}),"\n",(0,o.jsx)(t.h2,{id:"podium-proxy",children:"Podium Proxy"}),"\n",(0,o.jsx)(t.p,{children:"Podium proxying is the Podium way for a podlet to inform any layout servers that consume it that there are additional routes and that they should be given public access via routes on the layout server."}),"\n",(0,o.jsx)(t.h3,{id:"how-it-works",children:"How it works"}),"\n",(0,o.jsx)(t.p,{children:"For each proxy you define in a podlet, a namespaced route will be mounted on a layout which will proxy requests back to the podlet. This works as follows:"}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsx)(t.li,{children:"A podlet defines its proxy routes"}),"\n",(0,o.jsx)(t.li,{children:"A podlet puts the location of the proxy routes into its manifest file"}),"\n",(0,o.jsx)(t.li,{children:"A layout reads a podlets manifest file including proxy information"}),"\n",(0,o.jsx)(t.li,{children:"A layout creates namespaced proxy routes"}),"\n",(0,o.jsx)(t.li,{children:"A layout sends information to the podlet via context headers about the public location of these routes"}),"\n",(0,o.jsx)(t.li,{children:"A podlet uses context headers to construct URLs pointing to the layout's proxy endpoints"}),"\n"]}),"\n",(0,o.jsx)(t.p,{children:"In a podlet's manifest, a proxy object can be used to define up to 4 proxy routes like so:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-json",children:'{\n    ...\n    "name": "myPodlet",\n    "proxy": {\n        "api": "/api"\n    }\n    ...\n}\n'})}),"\n",(0,o.jsx)(t.p,{children:"This will result in a URL being mounted on the layout server at:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"/<layout-pathname>/<prefix>/<podlet-name>/<proxy-namespace>\n"})}),"\n",(0,o.jsx)(t.p,{children:"where:"}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsxs)(t.li,{children:[(0,o.jsx)(t.code,{children:"<layout-pathname>"}),": ",(0,o.jsx)(t.code,{children:"pathname"})," argument given ",(0,o.jsx)(t.code,{children:"new Layout({ pathname: '...' })"})]}),"\n",(0,o.jsxs)(t.li,{children:[(0,o.jsx)(t.code,{children:"<prefix>"}),": defaults to ",(0,o.jsx)(t.code,{children:"podium-resource"})]}),"\n",(0,o.jsxs)(t.li,{children:[(0,o.jsx)(t.code,{children:"<podlet-name>"}),": ",(0,o.jsx)(t.code,{children:"name"})," value used when registering a podlet in a layout with ",(0,o.jsx)(t.code,{children:"layout.client.register({ name: '...' })"})]}),"\n",(0,o.jsxs)(t.li,{children:[(0,o.jsx)(t.code,{children:"<proxy-namespace>"}),": podlet manifest ",(0,o.jsx)(t.code,{children:"proxy.<key>"})]}),"\n"]}),"\n",(0,o.jsxs)(t.p,{children:["So for a layout running locally on port ",(0,o.jsx)(t.code,{children:"1337"})," using ",(0,o.jsx)(t.code,{children:"pathname"})," 'myLayout' and consuming a podlet that serves the manifest file above we should be able to send requests to:"]}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.code,{children:"http://localhost:1337/myLayout/podium-resource/myPodlet/api"})}),"\n",(0,o.jsxs)(t.p,{children:["and expect that our requests would be proxied on to our podlet's ",(0,o.jsx)(t.code,{children:"/api"})," route."]}),"\n",(0,o.jsx)(t.h3,{id:"programmatically-defining-proxy-routes",children:"Programmatically defining proxy routes"}),"\n",(0,o.jsxs)(t.p,{children:["It's not necessary to define proxy routes in a manifest file manually. There is a ",(0,o.jsx)(t.code,{children:"podlet.proxy()"})," helper method you should use to define proxy routes and have the manifest file fields populated for you. The following example will achieve the same thing as shown earlier using this helper."]}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.em,{children:"Example"})}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-js",children:"podlet.proxy({ target: '/api', name: 'api' });\n"})}),"\n",(0,o.jsx)(t.p,{children:"What's more, we can also define the route itself at the same time."}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.em,{children:"Example"})}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-js",children:"app.get(podlet.proxy({ target: '/api', name: 'api' }), (req, res) => {\n    res.json({ key: 'value' });\n});\n"})}),"\n",(0,o.jsx)(t.p,{children:"There are a maximum of 4 proxies, however it is possible to mount multiple routes under a single proxy."}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.em,{children:"Example"})}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-js",children:"podlet.proxy({ target: '/api', name: 'api' });\n\napp.get('/api/cats', (req, res) => {\n    res.json([{ name: 'fluffy' }]);\n});\n// http://localhost:1337/myLayout/podium-resource/myPodlet/api/cats\n\napp.get('/api/dogs', (req, res) => {\n    res.json([{ name: 'rover' }]);\n});\n// http://localhost:1337/myLayout/podium-resource/myPodlet/api/dogs\n"})}),"\n",(0,o.jsx)(t.p,{children:"Specifying an absolute URL is also possible in which case the layout will mount a proxy directly to the URL, bypassing the podlet entirely."}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.em,{children:"Example"})}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-js",children:"podlet.proxy({ name: 'remote-api', target: 'http://<some-service:port>/api' });\n\n// http://localhost:1337/myLayout/podium-resource/myPodlet/remote-api\n"})}),"\n",(0,o.jsx)(t.h3,{id:"constructing-proxy-urls",children:"Constructing Proxy URLs"}),"\n",(0,o.jsx)(t.p,{children:"When creating a podlet with proxy routes, it's necessary to be able to dynamically, programmatically determine the location of these proxy routes."}),"\n",(0,o.jsx)(t.p,{children:"The base URL can be constructed by joining together values plucked from the Podium context like so."}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-js",children:"const { URL } = require('url'); // not required in node >=10\n\napp.get(podlet.content(), (req, res) => {\n    const { mountOrigin, publicPathname } = res.locals.podium.context;\n    const url = new URL(publicPathname, mountOrigin);\n\n    // prints base URL under which all proxy routes are located\n    console.log(url.href);\n});\n"})}),"\n",(0,o.jsxs)(t.p,{children:["The path to a given endpoint can then be constructed by joining this base URL together with the namespace key given to the ",(0,o.jsx)(t.code,{children:"podlet.proxy()"})," method like so:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-js",children:"// define and create an API proxy route\napp.get(podlet.proxy({ target: '/api', name: 'api' }), (req, res) => {\n    res.json({...});\n});\n\napp.get(podlet.content(), (req, res) => {\n    // construct an absolute URL to the API proxy route\n     const { mountOrigin, publicPathname } = res.locals.podium.context;\n    const url = new URL(publicPathname, mountOrigin);\n\n    // prints specific absolute URL to API proxy endpoint\n    console.log(url.href + 'api');\n});\n"})}),"\n",(0,o.jsx)(t.h3,{id:"example-client-side-javascript-fetching-data-from-a-content-route",children:"Example: client side JavaScript fetching data from a /content route"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-js",children:"const express = require('express');\nconst Podlet = require('@podium/podlet');\n\nconst podlet = new Podlet({\n    name: 'myPodlet',\n    version: '1.0.0',\n    pathname: '/',\n});\n\nconst app = express();\n\napp.get(podlet.manifest(), (req, res) => {\n    res.status(200).json(podlet);\n});\n\napp.get(podlet.proxy({ target: '/content', name: 'content' }), (req, res) => {\n    res.send('This is the actual content for the page');\n});\n\napp.get(podlet.content(), (req, res) => {\n    const { mountOrigin, publicPathname } = res.locals.podium.context;\n    const url = new URL(publicPathname, mountOrigin);\n\n    res.send(`\n        <div id=\"content-placeholder\"></div>\n        <script>\n            fetch('${url.href + 'content'}')\n                .then((response) => response.text())\n                .then(content => {\n                    const el = document.getElementById('content-placeholder');\n                    el.innerHTML = content;\n                });\n        <\/script>\n    `);\n});\n\napp.listen(7100);\n"})})]})}function p(e={}){const{wrapper:t}={...(0,s.a)(),...e.components};return t?(0,o.jsx)(t,{...e,children:(0,o.jsx)(c,{...e})}):c(e)}},1151:(e,t,n)=>{n.d(t,{Z:()=>a,a:()=>r});var o=n(7294);const s={},i=o.createContext(s);function r(e){const t=o.useContext(i);return o.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),o.createElement(i.Provider,{value:t},e.children)}}}]);