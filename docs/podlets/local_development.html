<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>üî• Local Development</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link type="text/css" rel="stylesheet" href="/Podium/docs/assets/style.css" />
  <link type="text/css" rel="stylesheet" href="/Podium/docs/assets/pilcrow.css" />
  <link type="text/css" rel="stylesheet" href="/Podium/docs/assets/hljs-github.min.css"/>
  <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.10.0/github-markdown.min.css"/>
  <link rel="shortcut icon" href="/Podium/docs/assets/podium.png" type="image/x-icon">
</head>
<body>
  <header>
    <a class="logo" href="/Podium">
      <img class="podium" src="/Podium/docs/assets/podium.png">
      Podium
    </a>
    <div class="links">
      <a href="https://github.schibsted.io/Podium" target="_blank">GitHub</a>
    </div>
  </header>
  <div class="content">
    <nav>
      
      <h3>Podium</h3>
      <ul>
        <li><a href="/Podium/docs/podium/conceptual_overview.html">üìö Overview</a></li>
      </ul>
      
      <h3>Podlet</h3>
      <ul>
        <li><a href="/Podium/docs/podlets/getting_started.html">üöÄ Getting Started</a></li>
        <li><a href="/Podium/docs/podlets/fallbacks.html">üîå Fallbacks</a></li>
        <li><a href="/Podium/docs/podlets/proxying.html">üê† Proxying</a></li>
        <li><a href="/Podium/docs/podlets/context.html">‚úÇÔ∏è Context</a></li>
        <li><a href="/Podium/docs/podlets/assets.html">üì¶ Assets</a></li>
        <li><a href="/Podium/docs/podlets/local_development.html">üî• Local Development</a></li>
      </ul>

      <!--
      <h2>Layouts</h2>
      <h3>üìö Guides</h3>
      <ul>
        <li><a href="layouts_getting_started.html">üöÄ Getting Started</a></li>
      </ul>
      -->

      <h3>API Docs</h3>
      <ul>
        <li><a href="https://github.schibsted.io/Podium/podlet/blob/master/README.md">üìö Podlet</a></li>
        <li><a href="https://github.schibsted.io/Podium/layout/blob/master/README.md">üìö Layout</a></li>
        <li><a href="https://github.schibsted.io/Podium/context/blob/master/README.md">üìö Context</a></li>
        <li><a href="https://github.schibsted.io/Podium/proxy/blob/master/README.md">üìö Proxy</a></li>
        <li><a href="https://github.schibsted.io/Podium/client/blob/master/README.md">üìö Client</a></li>
      </ul>
    </nav>
    <main class="markdown-body"><h1 id="üî•-local-development"><a class="header-link" href="#üî•-local-development"></a>üî• Local Development</h1>
<h2 id="background"><a class="header-link" href="#background"></a>Background</h2>
<p>It is intended that Podlets be developed in isolation from layouts or other Podlets. This isolation can introduce challenges into local development due to some components normally provided by a layout (such as headers and Assets) not being available.</p>
<h2 id="a-basic-podlet-development-setup"><a class="header-link" href="#a-basic-podlet-development-setup"></a>A basic podlet development setup</h2>
<p>At its most basic, the experience of developing a podlet on its own can be as simple as starting the podlet and visiting its URL in your favourite browser.</p>
<p>Consider the following very simple podlet server:</p>
<pre class="hljs"><code><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">const</span> Podlet = <span class="hljs-built_in">require</span>(<span class="hljs-string">'@podium/podlet'</span>);

<span class="hljs-keyword">const</span> podlet = <span class="hljs-keyword">new</span> Podlet({
    <span class="hljs-attr">name</span>: <span class="hljs-string">'myPodlet'</span>,
    <span class="hljs-attr">version</span>: <span class="hljs-string">'1.0.0'</span>,
});

<span class="hljs-keyword">const</span> app = express();

app.get(podlet.manifest(), (req, res) =&gt; {
    res.json(podlet);
});

app.get(podlet.content(), (req, res) =&gt; {
    res.send(<span class="hljs-string">`&lt;div&gt;This is my content&lt;/div&gt;`</span>);
});

app.listen(<span class="hljs-number">7100</span>);</code></pre><p>If this content were saved in a file called <code>server.js</code> and run with the command:</p>
<pre class="hljs"><code>node server.js</code></pre><p>then you could simply visit the following routes to test your changes</p>
<ul class="list">
<li><code>http://localhost:7100/manifest.json</code>: the podlet&#39;s manifest route</li>
<li><code>http://localhost:7100</code>: the podlet&#39;s content route</li>
</ul>
<h2 id="problems-and-improvements"><a class="header-link" href="#problems-and-improvements"></a>Problems and improvements</h2>
<h3 id="restarting-the-server"><a class="header-link" href="#restarting-the-server"></a>Restarting the server</h3>
<p>The first problem with the basic setup described above is that every time you make a change to your server, you will need to stop and restart your server before refreshing your browser window in order to see changes.</p>
<p>This is not so much a Podium problem as it is a common Node.js problem and it&#39;s easily solved. A common way to do so is to use a module such as <a href="http://nodemon.io">nodemon</a> to monitor your file system and restart your server automatically anytime relevant files change.</p>
<p><em>Use nodemon to run your server</em></p>
<pre class="hljs"><code>npx nodemon server.js</code></pre><p>See the <a href="https://github.com/remy/nodemon#nodemon">nodemon docs</a> for more information.</p>
<h3 id="missing-context-headers"><a class="header-link" href="#missing-context-headers"></a>Missing context headers</h3>
<p>When a podlet is being run in the context of a layout server, the layout server will send a number of podium context headers with each request. If your podlet depends on these headers to get its work done, developing the podlet locally maybe be difficult or impossible out of the box.</p>
<p>Consider a podlet with the following content route:</p>
<pre class="hljs"><code>app.get(podlet.content(), (req, res) =&gt; {
    <span class="hljs-keyword">const</span> { mountOrigin } = res.locals.podium.context;
    res.send(<span class="hljs-string">`&lt;div&gt;<span class="hljs-subst">${mountOrigin}</span>&lt;/div&gt;`</span>);
});</code></pre><p>This podlet will behave correctly when send requests by a layout but it will throw an error if you try to visit <code>/</code> directly in your browser.</p>
<p>To solve this, we provide something called <code>defaults</code>. When enabled, you can set defaults for Podium context values that will be overwritten, and therefore not used, when requests are sent from the layout to the podlet.</p>
<p>To enable this feature, pass <code>defaults: true</code> to the podlet constructor like so:</p>
<pre class="hljs"><code><span class="hljs-keyword">const</span> podlet = <span class="hljs-keyword">new</span> Podlet({
    ...
    defaults: <span class="hljs-literal">true</span>,
})</code></pre><p>Then rewriting our previous example we can provide sensible development defaults for context values:</p>
<pre class="hljs"><code>podlet.defaults({
    <span class="hljs-attr">mountOrigin</span>: <span class="hljs-string">'http://localhost:7100'</span>,
});

app.get(podlet.content(), (req, res) =&gt; {
    <span class="hljs-keyword">const</span> { mountOrigin } = res.locals.podium.context;
    res.send(<span class="hljs-string">`&lt;div&gt;<span class="hljs-subst">${mountOrigin}</span>&lt;/div&gt;`</span>);
});</code></pre><h3 id="html-pages,-page-fragments-and-assets"><a class="header-link" href="#html-pages,-page-fragments-and-assets"></a>HTML pages, page fragments and assets</h3>
<p>In production, your content route will be responding with an HTML fragment devoid of its wrapping <code>&lt;html&gt;</code> or <code>&lt;body&gt;</code> tags. However, in development you will want to wrap your fragment in a light HTML page wrapper, especially if your podlet makes use of client side assets such as JavaScript or CSS.</p>
<p><em>In production</em></p>
<p>In this example, the returned content is kept slim and simple, a single <code>&lt;div&gt;</code> is returned and client side assets are handled elsewhere.</p>
<pre class="hljs"><code><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>My content fragment<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></code></pre><p><em>In development</em></p>
<p>When working on this podlet in isolation however, we want to be able to visit the podlet directly in a browser and see an HTML page so we wrap it in <code>&lt;html&gt;</code> and <code>&lt;body&gt;</code> tags. Once we do this, we gain the ability to link in JavaScript and CSS development assets so we can properly see what we are working on.</p>
<pre class="hljs"><code><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"..."</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>My content fragment<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"..."</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></code></pre><p>While there are any number of ways to support client side JavaScript and CSS assets in your podlets, in many cases, you will run into the problem of wanting to serve your assets directly with your podlet while in development and not while running in production.</p>
<h4 id="asset-pipe-in-development-mode"><a class="header-link" href="#asset-pipe-in-development-mode"></a>Asset pipe in development mode</h4>
<p>If you are using the <a href="https://github.com/asset-pipe">asset-pipe</a> project for distributed asset bundling as described in the <a href="./assets.html">assets</a> section of these guides then you can put the asset pipe client in development mode in order to have assets bundled and served on local URLs that you can then link to in your development templates.</p>
<pre class="hljs"><code><span class="hljs-keyword">const</span> assets = <span class="hljs-keyword">new</span> Assets({
    ...
    development: <span class="hljs-literal">true</span>,
})</code></pre><p>When in development mode, JavaScript will automatically be served at the route <code>/js</code> and CSS will automatically be served at the route <code>/css</code>. You can then put these URLs directly into your development template. An advantage of this approach is that you will not need to restart the server when making changes to your client side assets. Refreshing the page to see changes will be enough.</p>
<pre class="hljs"><code><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/css"</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>My content fragment<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/js"</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></code></pre><h4 id="putting-it-together"><a class="header-link" href="#putting-it-together"></a>Putting it together</h4>
<p>The following example shows a setup using <code>asset-pipe</code> that works correctly both in development and production.</p>
<pre class="hljs"><code><span class="hljs-keyword">const</span> Assets = <span class="hljs-built_in">require</span>(<span class="hljs-string">'@asset-pipe/client'</span>);
<span class="hljs-keyword">const</span> Podlet = <span class="hljs-built_in">require</span>(<span class="hljs-string">'@podium/podlet'</span>);
<span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);

<span class="hljs-keyword">const</span> podlet = <span class="hljs-keyword">new</span> Podlet({
    <span class="hljs-attr">name</span>: <span class="hljs-string">'myPodlet'</span>,
    <span class="hljs-attr">version</span>: <span class="hljs-string">'1.0.0'</span>,
});

<span class="hljs-keyword">const</span> assets = <span class="hljs-keyword">new</span> Assets({
    <span class="hljs-attr">buildServerUri</span>: <span class="hljs-string">'http://some-asset-server.com'</span>,
    <span class="hljs-attr">tag</span>: podlet.name,
    <span class="hljs-attr">js</span>: __dirname + <span class="hljs-string">'/assets/script.js'</span>,
    <span class="hljs-attr">css</span>: __dirname + <span class="hljs-string">'/assets/style.css'</span>,
    <span class="hljs-attr">development</span>: process.env.NODE_ENV === <span class="hljs-string">'development'</span>,
});

<span class="hljs-keyword">const</span> app = express();

app.use(assets.middleware());
app.use(podlet.middleware());

app.get(podlet.manifest(), (req, res) =&gt; {
    podlet.js(assets.js());
    podlet.css(assets.css());

    res.json(podlet);
});

app.get(podlet.content(), (req, res) =&gt; {
    <span class="hljs-keyword">const</span> fragment = <span class="hljs-string">`&lt;div&gt;My content fragment&lt;/div&gt;`</span>;

    <span class="hljs-keyword">if</span> (process.env.NODE_ENV === <span class="hljs-string">'development'</span>) {
        res.send(<span class="hljs-string">`
            &lt;html&gt;
                &lt;head&gt;
                    &lt;link rel="stylesheet" href="/css"&gt;
                &lt;/head&gt;
                &lt;body&gt;
                    <span class="hljs-subst">${fragment}</span>
                    &lt;script src="/js"&gt;&lt;/script&gt;
                &lt;/body&gt;
            &lt;/html&gt;
        `</span>);
    } <span class="hljs-keyword">else</span> {
        res.send(fragment);
    }
});

app.listen(<span class="hljs-number">7100</span>);</code></pre><h3 id="proxying-to-absolute-urls"><a class="header-link" href="#proxying-to-absolute-urls"></a>Proxying to absolute URLs</h3>
<p>A slight edge case you may encounter when working locally with proxying is that absolute URLs are proxied to directly from layouts, in some cases bypassing podlets entirely.</p>
<pre class="hljs"><code>podlet.proxy(<span class="hljs-string">'http://google.com'</span>, <span class="hljs-string">'google'</span>);</code></pre><p>will generate the following entry in the podlet&#39;s manifest</p>
<pre class="hljs"><code>{
    ...
    <span class="hljs-attr">"proxy"</span>: {
        <span class="hljs-attr">"google"</span>: <span class="hljs-string">"http://google.com"</span>
    }
}</code></pre><p>When this is consumed by a layout, the layout will mount a proxy from the layout directly to <code>http://google.com</code> without sending any traffic to the podlet. When working locally on your podlet in isolation this will mean that the proxy is simply not available to you.</p>
<p>The preferred way to overcome this challenge is to mount a proxy in the podlet for development purposes</p>
<pre class="hljs"><code>podlet.proxy(<span class="hljs-string">'http://google.com'</span>, <span class="hljs-string">'google'</span>);

<span class="hljs-keyword">if</span> (process.env.NODE_ENV === <span class="hljs-string">'development'</span>) {
    <span class="hljs-keyword">const</span> proxy = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Proxy</span>();
    app.use(proxy.middleware());
    proxy.register(podlet);
}</code></pre>    </main>
  </div>
  <script>
    (function () {
      var pathname = window.location.pathname.substr(1);
      var activeLink = document.querySelector('a[href="' + pathname + '"]');

      activeLink.classList.add('selected');
    })();
  </script>
</body>
</html>
